#! /bin/bash

set -eux

cd vulsctl/docker

dck="docker run --rm --log-driver=awslogs --log-opt awslogs-region=$AWS_REGION --log-opt awslogs-group=/ec2/vuls/packer --log-opt tag='${PACKER_AMI_NAME}-{{ with split .ImageName \":\" }}{{ join . \"-\"}}{{ end }}-{{ .ID }}' --log-opt awslogs-create-group=true -t -v ${PWD}:/vuls"

# cite from https://github.com/vulsio/vulsctl/blob/master/docker/oval.sh
sudo su -c "docker pull vuls/goval-dictionary" $USER

sudo su -c "$dck vuls/goval-dictionary fetch-redhat 5 6 7 8" $USER
sudo su -c "$dck vuls/goval-dictionary fetch-amazon" $USER
sudo su -c "$dck vuls/goval-dictionary fetch-debian 7 8 9 10" $USER
sudo su -c "$dck vuls/goval-dictionary fetch-ubuntu 14 16 18 19 20" $USER
sudo su -c "$dck vuls/goval-dictionary fetch-alpine 3.3 3.4 3.5 3.6 3.7 3.8 3.9 3.10 3.11" $USER

# cite from https://github.com/vulsio/vulsctl/blob/master/docker/gost.sh
sudo su -c "docker pull vuls/gost" $USER

sudo su -c "$dck vuls/gost fetch redhat" $USER
sudo su -c "$dck vuls/gost fetch debian" $USER

# cite from https://github.com/vulsio/vulsctl/blob/master/docker/cvedb.sh
sudo su -c "docker pull vuls/go-cve-dictionary" $USER

RELEASE=v0.12.0
URL=https://github.com/future-architect/vuls/releases/download/${RELEASE}/cve.sqlite3.gz 

if [ ! -e ./cve.sqlite3 ]; then
    echo "Fetching cve.sqlite3 from GitHub Vuls: ${URL}"
    curl -OL ${URL}
    gunzip ./cve.sqlite3.gz
fi

# TODO: 実行中のエラーに対処し、毎回実行するようにする
# for i in `seq 2002 $(date +"%Y")`; do \
#     sudo su -c "$dck vuls/go-cve-dictionary fetchnvd -years $i" $USER
# done
# 
# for i in `seq 1998 $(date +"%Y")`; do \
#     sudo su -c "$dck vuls/go-cve-dictionary fetchjvn -years $i" $USER
# done

# cite from https://github.com/vulsio/vulsctl/blob/master/docker/exploitdb.sh
sudo su -c "docker pull vuls/go-exploitdb" $USER

sudo su -c "$dck vuls/go-exploitdb fetch exploitdb" $USER

# cite from https://github.com/vulsio/vulsctl/blob/master/docker/msfdb.sh
sudo su -c "docker pull vuls/go-msfdb" $USER

sudo su -c "$dck vuls/go-msfdb fetch msfdb" $USER
